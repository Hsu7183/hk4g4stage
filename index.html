<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>交易剪貼簿分析（MVP）</title>

<!-- ⭐ 極簡內嵌樣式：放大字體、加按鈕樣式 -->
<style>
body{font-family:system-ui,sans-serif;max-width:60rem;margin:2rem auto}
h1{margin-bottom:1rem}
button,label.btn{padding:.5rem 1rem;margin-right:.5rem;border:0;border-radius:.25rem;cursor:pointer;color:#fff;background:#007bff}
input[type=file]{display:none}
pre{background:#f6f8fa;padding:1rem;border-radius:.4rem;white-space:pre-wrap}
table{width:100%;border-collapse:collapse;margin-top:1rem}
th,td{border:1px solid #ccc;padding:.4rem;text-align:center}
th{background:#eee}
</style>
</head>

<body>
<h1>交易剪貼簿分析（MVP）</h1>

<!-- 兩種匯入方式 -->
<button onclick="readClipboard()">貼上剪貼簿內容</button>
<label class="btn">選擇檔案 <input type="file" id="file" accept=".txt,.TF"></label>

<pre id="stats">（尚無資料）</pre>
<table id="tbl" hidden>
  <thead><tr><th>平倉時間</th><th>多空</th><th>點數</th><th>盈虧(元)</th></tr></thead>
  <tbody></tbody>
</table>

<!-- ⭐ 全部 JS 放這裡，一檔到位 -->
<script type="module">
/* ===== 參數與正反向動作定義 ===== */
const MULT = 200;                            // 台指期 1點=200元
const ENTRY = ['新買','新賣'];
const EXIT_L = ['平賣','強制平倉'];          // 平多
const EXIT_S = ['平買','強制平倉'];          // 平空

/* ===== 讀剪貼簿 ===== */
async function readClipboard(){
  try{
    const txt = await navigator.clipboard.readText();
    analyse(txt);
  }catch(e){alert('讀取剪貼簿失敗：'+e.message);}
}

/* ===== 讀檔上傳 ===== */
document.getElementById('file').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f)return;
  const r=new FileReader();
  r.onload=()=>analyse(new TextDecoder('big5').decode(r.result)); // Big5→UTF-8
  r.readAsArrayBuffer(f);
});

/* ===== 解析→配對→統計 ===== */
function analyse(txt){
  const rows=txt.trim().split(/\r?\n/);
  const q=[];               // 未平倉佇列
  const trades=[];          // 完成配對
  rows.forEach(r=>{
    const [ts,pStr,act]=r.trim().split(/\s+/); if(!act)return;
    const price=+parseFloat(pStr);             // 15663.000000→15663
    // 建倉
    if(ENTRY.includes(act)){q.push({side:act==='新買'?'L':'S',pIn:price,tsIn:ts});return;}
    // 平倉
    const idx=q.findIndex(o=>
      (o.side==='L' && EXIT_L.includes(act)) ||
      (o.side==='S' && EXIT_S.includes(act)));
    if(idx===-1)return;                        // 找不到對應持倉
    const pos=q.splice(idx,1)[0];
    const pts= pos.side==='L'? price-pos.pIn : pos.pIn-price;
    trades.push({ts,side:pos.side==='L'?'多':'空',pts,pnl:pts*MULT});
  });

  if(!trades.length){alert('沒有成功配對的交易！');return;}

  /* ---- 統計 ---- */
  const ttl=trades.length;
  const win=trades.filter(t=>t.pnl>0);
  const loss=trades.filter(t=>t.pnl<0);
  const gp=sum(win.map(t=>t.pnl));
  const gl=sum(loss.map(t=>t.pnl));
  const net=gp+gl;
  const pf=Math.abs(gl)?(gp/Math.abs(gl)).toFixed(2):'∞';
  const wRate=(win.length/ttl*100).toFixed(2)+'%';

  /* ---- 顯示統計 ---- */
  document.getElementById('stats').textContent=
`總交易筆數 : ${ttl}
勝率       : ${wRate}
淨利       : ${fmt(net)} 元
毛利 / 毛損: ${fmt(gp)} / ${fmt(gl)} 元
獲利因子   : ${pf}`;

  /* ---- 填表 ---- */
  const tbody=document.querySelector('#tbl tbody');
  tbody.innerHTML='';
  trades.forEach(t=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${t.ts}</td><td>${t.side}</td><td>${t.pts}</td><td>${fmt(t.pnl)}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('tbl').hidden=false;
}

/* ===== 小工具 ===== */
const sum=a=>a.reduce((x,y)=>x+y,0);
const fmt=n=>(+n).toLocaleString('zh-TW');
</script>
</body>
</html>
